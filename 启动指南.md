# OpenAI兼容格式的TTS API服务启动指南

本指南将帮助您快速配置并启动TTS API服务。

## 前提条件

在启动服务之前，请确保您的系统已安装：
- [Node.js](https://nodejs.org/) (版本 12.x 或更高)
- [npm](https://www.npmjs.com/) (Node.js 包管理器)

## 步骤 1：配置环境变量

1. 首先，复制 `.env.example` 文件并重命名为 `.env`：

   **Windows 命令行：**
   ```cmd
   copy .env.example .env
   ```

   **Windows PowerShell：**
   ```powershell
   Copy-Item .env.example .env
   ```

2. 使用文本编辑器打开 `.env` 文件，并根据您的实际情况修改以下配置：
   
   ```ini
   # 服务器配置
   PORT=3000
   HOST=0.0.0.0
   
   # 目标TTS API配置（这是最重要的部分，必须正确配置）
   TARGET_TTS_API_URL=https://api.example.com/tts  # 替换为实际的TTS API地址
   TTS_API_KEY=your-api-key-here                   # 替换为实际的API密钥
   
   # 可选配置（根据需要调整）
   API_AUTH_ENABLED=false
   API_KEY=your-auth-api-key
   CACHE_ENABLED=false
   RATE_LIMIT_ENABLED=false
   ```

   **关键配置说明：**
   - `TARGET_TTS_API_URL`：目标TTS API的URL地址，必须正确设置，否则服务无法正常工作
   - `TTS_API_KEY`：目标TTS API的认证密钥，必须正确设置
   - `PORT`：服务监听的端口，默认为3000

## 步骤 2：安装依赖

在项目根目录下运行以下命令安装所需的依赖包：

```cmd
npm install
```

这将会安装`package.json`中定义的所有依赖项，包括：
- express：Web服务器框架
- axios：HTTP请求库
- dotenv：环境变量管理
- cors：跨域资源共享
- express-rate-limit：请求限流
- nodemon：开发模式下的自动重启工具（开发依赖）

## 步骤 3：启动服务

根据您的需求，有两种启动方式：

### 方式一：生产环境启动

使用以下命令在生产环境模式下启动服务：

```cmd
npm start
```

这将会直接运行 `node index.js` 来启动服务。

### 方式二：开发环境启动

如果您正在开发或调试，可以使用以下命令启动服务：

```cmd
npm run dev
```

这将会使用 `nodemon` 启动服务，当您修改代码后，服务会自动重启，方便开发调试。

## 步骤 4：验证服务是否正常运行

服务启动后，您可以通过以下方式验证服务是否正常工作：

### 1. 检查健康状态

打开浏览器或使用curl命令访问健康检查端点：

**浏览器访问：**
http://localhost:3000/health

**curl命令（需要先安装curl工具）：**
```cmd
curl http://localhost:3000/health
```

如果服务正常运行，您将看到类似以下的响应：
```json
{
  "status": "ok",
  "timestamp": "2023-11-08T12:34:56.789Z",
  "version": "1.0.0",
  "memoryUsage": {
    "rss": "45MB",
    "heapUsed": "23MB"
  }
}
```

### 2. 测试TTS API

您可以使用curl命令或其他工具测试TTS API功能：

**curl命令示例：**
```cmd
curl http://localhost:3000/v1/audio/speech ^
  -H "Content-Type: application/json" ^
  -d "{^\n    \"model\": \"tts-1\",^\n    \"input\": \"你好，这是一段测试文本。\",^\n    \"voice\": \"alloy\",^\n    \"response_format\": \"mp3\",^\n    \"speed\": 1.0^\n  }" > speech.mp3
```

如果请求成功，将生成一个名为 `speech.mp3` 的音频文件。

## 常见问题解决

### 1. 服务启动失败

- 检查端口是否被占用：尝试修改 `.env` 文件中的 `PORT` 值
- 检查依赖是否正确安装：重新运行 `npm install`
- 检查Node.js版本：确保使用的是支持的Node.js版本

### 2. TTS请求失败

- 检查目标TTS API的URL和密钥是否正确配置
- 检查网络连接是否正常
- 查看控制台输出的错误信息，根据错误提示进行排查

### 3. 其他问题

- 如果启用了API认证，请确保在请求头中包含正确的API密钥
- 如果启用了请求限流，请注意不要超过配置的请求频率
- 查看日志文件（如果已配置）获取更详细的运行信息

## 注意事项

- 在生产环境中，建议启用API认证和请求限流功能，以保护服务安全
- 根据您的使用情况，适当调整缓存设置以提高性能
- 如果修改了代码，请重新启动服务（开发模式下会自动重启）
- 定期更新依赖包以确保安全性和稳定性